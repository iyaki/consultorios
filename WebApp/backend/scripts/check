#!/usr/bin/env bash

if [ -z "$CI" ]
then
  set -e
  set -o pipefail
fi

CODE_DIRECOTRY='app/'

SCRIPT_DIR="$(dirname $(realpath "$0"))"

source "$SCRIPT_DIR/../../../packages/bash/ci_utils.sh"

cd "$SCRIPT_DIR/../"

"$SCRIPT_DIR/setup"

check_exit_status $?
print_separator

ecs --clear-cache

check_exit_status $?
print_separator

composer-unused --excludePackage=consultorios/rest-framework

check_exit_status $?
print_separator

composer-require-checker

check_exit_status $?
print_separator

phpmnd \
  --strings \
  --include-numeric-string \
  -- $CODE_DIRECOTRY

check_exit_status $?
print_separator

phpcpd $CODE_DIRECOTRY

check_exit_status $?
print_separator

psalm \
  --threads=4 \
  --no-cache

check_exit_status $?
print_separator

# vendor/bin/phpunit $CODE_DIRECOTRY

# check_exit_status "$UNIT_TESTS_STATUS"

composer dump-autoload \
  --optimize \
  --no-cache \
  --no-interaction

if [ "$EXIT_STATUS" != "0" ]
then
  exit 1
fi
